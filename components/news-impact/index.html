<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>News Impact – Standalone Carousel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f8fb;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--ring:rgba(14,165,233,.25);
      --border:#e5e7eb;--btn:#0ea5e9;--pos:#059669;--neu:#64748b;--neg:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:400 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1152px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:clamp(22px,2.2vw,28px)}
    .hint{color:var(--muted);margin-bottom:18px}
    .carousel{position:relative;display:grid;grid-auto-flow:column;gap:16px;overflow:auto;scroll-snap-type:x mandatory;padding:2px 2px 10px;-webkit-overflow-scrolling:touch;}
    .carousel::-webkit-scrollbar{height:10px}
    .carousel::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
    .item{scroll-snap-align:center;min-width:min(520px,90vw)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(2,6,23,.07);display:flex;flex-direction:column;gap:10px;outline:0;}
    .card:focus-visible{box-shadow:0 0 0 6px var(--ring)}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .company{font-weight:700;font-size:clamp(16px,1.6vw,18px)}
    .muted{color:var(--muted)}
    .summary{color:var(--muted)}
    .impact b{font-weight:700}
    .chip{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:600;background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a}
    .chip.pos{background:rgba(5,150,105,.1);color:var(--pos);border-color:rgba(5,150,105,.25)}
    .chip.neu{background:rgba(100,116,139,.1);color:var(--neu);border-color:rgba(100,116,139,.25)}
    .chip.neg{background:rgba(220,38,38,.1);color:var(--neg);border-color:rgba(220,38,38,.25)}
    .score-head{display:flex;justify-content:space-between;align-items:center}
    .score-wrap{width:100%;background:#eef2f7;border:1px solid var(--border);border-radius:10px;height:10px;overflow:hidden}
    .score-bar{height:100%;width:0%;border-radius:10px;background:linear-gradient(90deg,#3b82f6,#06b6d4)}
    .controls{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    button.nav{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:600}
    button.nav:focus-visible{outline:none;box-shadow:0 0 0 4px var(--ring)}
    a.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;font-weight:600;text-decoration:none;background:var(--btn);color:#fff;border-radius:12px;border:1px solid var(--btn)}
    a.btn:hover{filter:brightness(.95)}
    .count{font-weight:600}
    @media (max-width:640px){ .item{min-width:92vw} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>News Impact</h1>
    <div class="hint"><span class="count" id="count" hidden></span> company • symbol • dt • sentiment • impact • score • summary • link</div>
    <div class="controls" aria-hidden="true">
      <button class="nav" id="prevBtn" aria-label="Previous">⟵ Prev</button>
      <button class="nav" id="nextBtn" aria-label="Next">Next ⟶</button>
    </div>
    <div id="carousel" class="carousel" aria-label="News Impact Carousel" tabindex="0"></div>
  </div>

  <script>
    // ----------------------------
    // Utilities
    // ----------------------------
    const $ = sel => document.querySelector(sel);
    function esc(s){ return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
    function sentimentClass(s){ const t=String(s||"").toLowerCase(); if(t.includes("pos"))return"pos"; if(t.includes("neg"))return"neg"; return"neu"; }
    function clampScore(x){ const n=Number(x); return Number.isFinite(n)?Math.max(0,Math.min(10,n)):0; }
    function pct(score){ return `${clampScore(score)*10}%`; }
    function fmtDate(dt){ try { return new Date(dt).toLocaleString(); } catch { return String(dt ?? ""); } }

    // ----------------------------
    // Rendering
    // ----------------------------
    function buildCard(doc){
      const company   = doc?.company ?? "";
      const symbol    = doc?.symbol ?? "";
      const when      = doc?.dt ?? "";
      const summary   = doc?.summary ?? "";
      const impact    = doc?.impact ?? "";
      const score     = clampScore(doc?.score);
      const sentiment = doc?.sentiment ?? "Neutral";
      const newsUrl   = doc?.link ?? "#";

      const item = document.createElement("div"); item.className = "item";

      const a = document.createElement('a');
      a.className = 'btn';
      a.textContent = 'Open news link';
      try {
        const u = new URL(String(newsUrl), location.href);
        if (u.protocol === 'http:' || u.protocol === 'https:') a.href = u.href;
      } catch {}
      a.target = '_blank';
      a.rel = 'noopener noreferrer';

      item.innerHTML = `
        <article class="card" tabindex="0" role="group" aria-roledescription="slide" aria-label="${esc(company)} (${esc(symbol)}) – ${esc(sentiment)} – score ${score}/10">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <div class="company">${esc(company)}</div>
              <span class="chip ${sentimentClass(sentiment)}">${esc(sentiment)}</span>
            </div>
            <div class="muted">${esc(symbol)} • ${esc(fmtDate(when))}</div>
          </div>

          <div class="summary">${esc(summary)}</div>

          <div class="impact"><b>Impact:</b> <span>${esc(impact)}</span></div>

          <div>
            <div class="score-head">
              <div class="muted">Impact score</div>
              <div><b>${score}</b>/10</div>
            </div>
            <div class="score-wrap" role="meter" aria-valuemin="0" aria-valuemax="10" aria-valuenow="${score}" aria-label="Impact score">
              <div class="score-bar" style="width:${pct(score)}"></div>
            </div>
          </div>

          <div class="row" style="justify-content:space-between;margin-top:6px">
            <span data-link-slot></span>
          </div>
        </article>`;
      item.querySelector('[data-link-slot]').appendChild(a);
      return item;
    }

    function render(list){
      const host = $("#carousel");
      host.innerHTML = "";
      (Array.isArray(list) ? list : []).forEach(d => host.appendChild(buildCard(d)));

      const hasItems = list && list.length > 0;
      const controls = document.querySelector('.controls');
      const count = $("#count");
      if (controls) controls.setAttribute('aria-hidden', hasItems ? 'false' : 'true');
      if (count) {
        if (hasItems){ count.textContent = `${list.length} result${list.length>1?'s':''}`; count.hidden = false; }
        else { count.hidden = true; }
      }
    }

    // ----------------------------
    // Data: render ONLY when items exist
    // ----------------------------
    function extractItems(payload){
      if (!payload) return null;
      if (Array.isArray(payload?.items)) return payload.items;
      if (Array.isArray(payload)) return payload;
      if (payload?.structuredContent && Array.isArray(payload.structuredContent.items)) return payload.structuredContent.items;
      return null;
    }

    function renderIfItems(payload){
      const items = extractItems(payload);
      if (Array.isArray(items) && items.length){
        render(items);
        return true;
      }
      return false;
    }

    function attachOpenAIBridge(){
      if (!window.openai) return;

      // Current tool output snapshot (if host provides it)
      try {
        if (renderIfItems(window.openai.toolOutput)) return;
      } catch {}

      // Structured content updates
      if (typeof window.openai.onStructuredContentChanged === "function") {
        window.openai.onStructuredContentChanged((sc) => {
          renderIfItems(sc);
        });
      }

      // Tool output stream updates (some hosts use this)
      if (typeof window.openai.onToolOutputChanged === "function") {
        window.openai.onToolOutputChanged((out) => {
          renderIfItems(out);
        });
      }

      // Globals (rarely used for payload, kept as a no-op guard)
      if (typeof window.openai.onGlobalsChanged === "function") {
        window.openai.onGlobalsChanged((g) => {
          renderIfItems(g);
        });
      }
    }

    // ----------------------------
    // Boot (stay blank unless items arrive)
    // ----------------------------
    (async () => {
      const controls = document.querySelector('.controls');
      if (controls) controls.setAttribute('aria-hidden', 'true');

      attachOpenAIBridge();

      // Synchronous payloads (varies by host)
      if (renderIfItems(window.structuredContent)) return;
      if (renderIfItems(window.toolOutput)) return;

      // Remain blank until a tool result with non-empty items arrives.
    })();

    // ----------------------------
    // Controls (scroll + drag)
    // ----------------------------
    function cardWidth(){
      const host = $("#carousel");
      const first = host.querySelector(".item");
      if(!first) return 400;
      const gap = parseInt(getComputedStyle(host).gap||"16",10);
      return first.getBoundingClientRect().width + gap;
    }
    function smoothScroll(dir){
      const host = $("#carousel");
      host.scrollBy({left: dir * cardWidth(), behavior: "smooth"});
    }
    $("#nextBtn").addEventListener("click", ()=> smoothScroll(1));
    $("#prevBtn").addEventListener("click", ()=> smoothScroll(-1));
    const host = $("#carousel");
    let isDown=false, startX=0, startScroll=0;
    host.addEventListener("pointerdown",(e)=>{isDown=true;startX=e.clientX;startScroll=host.scrollLeft;host.setPointerCapture(e.pointerId);});
    host.addEventListener("pointermove",(e)=>{ if(!isDown) return; const dx=e.clientX-startX; host.scrollLeft=startScroll-dx; });
    host.addEventListener("pointerup",()=>{isDown=false;});
    host.addEventListener("pointercancel",()=>{isDown=false;});
  </script>
</body>
</html>
